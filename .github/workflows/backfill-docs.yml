name: Backfill Documentation

on:
  workflow_dispatch:
    inputs:
      tags:
        description: "Space/comma separated tags to rebuild (e.g., v1.0.0 v1.1.0)"
        required: true
      node-version:
        description: "Node version for builds"
        required: false
        default: "20"

jobs:
  backfill:
    runs-on: ubuntu-latest
    env:
      DOCS_OUTPUT: docs-build
      DOCS_BRANCH: docs-dist
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: https://npm.pkg.github.com

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

      - name: Prepare publish workspace
        run: |
          rm -rf docs-publish
          if git ls-remote --exit-code origin "${DOCS_BRANCH}" > /dev/null 2>&1; then
            git clone --depth 1 --branch "${DOCS_BRANCH}" "https://github.com/${GITHUB_REPOSITORY}.git" docs-publish
            rm -rf docs-publish/.git
          else
            mkdir docs-publish
          fi

      - name: Rebuild tagged releases
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}
        run: |
          set -euo pipefail
          TAGS="$(echo "${{ inputs.tags }}" | tr ',\n' ' ' | xargs)"
          if [ -z "$TAGS" ]; then
            echo "No tags provided"
            exit 1
          fi

          START_REF="$(git rev-parse HEAD)"

          for tag in $TAGS; do
            echo "=== Building docs for $tag ==="
            git checkout --force "$START_REF"
            git clean -fdx
            if ! git rev-parse "$tag" >/dev/null 2>&1; then
              echo "Tag $tag not found, skipping"
              continue
            fi
            git checkout --force "$tag"
            npm ci --ignore-scripts --legacy-peer-deps
            npm install --no-save --legacy-peer-deps \
              typedoc@^0.28.14 \
              typedoc-plugin-markdown@^4.9.0 \
              typedoc-plugin-frontmatter@^1.3.0
            npx algo-docs init --force
            npx algo-docs build
            npx algo-docs manifest
            TARGET="docs-publish/v${tag#v}"
            rm -rf "$TARGET"
            mkdir -p "$TARGET"
            cp -R "${DOCS_OUTPUT}/." "$TARGET/"
          done

          git checkout --force "$START_REF"

      - name: Publish docs branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs-publish
          publish_branch: ${{ env.DOCS_BRANCH }}
          keep_files: false
